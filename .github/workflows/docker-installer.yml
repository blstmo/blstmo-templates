name: Test Docker Installer Script

on:
  push:
    paths:
      - 'docker-installer/install.sh'
  pull_request:
    paths:
      - 'docker-installer/install.sh'

jobs:
  test-script:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        container: ['ubuntu:latest', 'debian:latest', 'almalinux:latest']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq docker.io containerd

      - name: Run Docker Installer Script in ${{ matrix.container }}
        run: |
          docker run --privileged --rm -d --name test-container ${{ matrix.container }} sleep infinity
          docker cp docker-installer/install.sh test-container:/install.sh
          docker exec test-container bash -c "
            if command -v apt-get &> /dev/null; then
              apt-get update && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                apt-utils \
                ca-certificates \
                curl \
                gnupg
            elif command -v dnf &> /dev/null; then
              dnf -y update && \
              dnf -y install \
                ca-certificates \
                curl \
                dnf-plugins-core
            fi && \
            chmod +x /install.sh && \
            bash /install.sh
          "

      - name: Verify Docker installation in ${{ matrix.container }}
        run: |
          docker exec test-container bash -c '
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed"
              exit 1
            fi
            echo "Docker version:"
            docker --version || true
            echo "Docker Compose version:"
            docker-compose --version || true
          '

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true